# ä¸»æˆåˆ†åˆ†æ

ä¸»æˆåˆ†åˆ†æ(Principal component analysisï¼ŒPCA) æ˜¯ä¸€ç§çº¿æ€§é™ç»´æ–¹æ³•ã€‚

<https://bryanhanson.github.io/LearnPCA/articles//Vig_04_Scores_Loadings.html>

å¯¹äºä¸€ç»„å˜é‡$X_1,X_2,...,X_p$,å­˜åœ¨å®ƒä»¬çš„çº¿æ€§ç»„åˆ **Y**ï¼Œä»¤$Var(y_1)$æœ€å¤§ï¼Œå¾—åˆ°$y_1$ï¼Œå†æ‰¾$y_2$ï¼Œ$y_2$ä¸$y_1$æ­£äº¤ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ‰¾åˆ°ä¸€ç»„æ— å…³ä¸»æˆåˆ† **Y**ã€‚

$$
y_i=a_{i1}x_1+a_{i2}x_2+...+a_{ip}x_p\\
Cov(y_i,y_j)=
\begin{cases}  &\lambda_i,\ i=j \\  
& 0,\ i\ne j
\end{cases}
$$

## è‡ªå®šä¹‰ PCA æ­¥éª¤

### æ•°æ®æ ‡å‡†åŒ–

Rä¸­æ•°æ®æ¡† nä¸ªè§‚æµ‹ï¼Œpä¸ªå˜é‡

$$
X=
\begin{bmatrix}
  x_{11}& x_{12} & ... & x_{1p}\\
 x_{21} & x_{22} & ... & x_{2p}\\
 \vdots  &  \vdots &   & \vdots \\
  x_{n1}& x_{n2} & ... & x_{np}
\end{bmatrix}
=(X_1,X_2,...X_p)
$$

å¯¹åŸå§‹æ•°æ®çŸ©é˜µæ ‡å‡†åŒ–ï¼Œæ¶ˆé™¤é‡çº²å’Œæ•°é‡çº§çš„å½±å“ã€‚

æ•°æ®æ ‡å‡†åŒ–ç¡®ä¿å˜é‡åœ¨ç›¸åŒçš„å°ºåº¦ä¸Šï¼Œè¿™å¯¹äºPCAéå¸¸é‡è¦ã€‚

ä½¿ç”¨Rè¯­è¨€å†…ç½®çš„ `USArrests` æ•°æ®é›†ï¼š

```{r}
df <- as_tibble(USArrests, rownames = "state") |> column_to_rownames("state")
head(df)

df_center <- scale(df,center = T,scale = T)
```

### è®¡ç®—åæ–¹å·®çŸ©é˜µ

å½“$\Sigma$ æœªçŸ¥æ—¶ï¼Œå…¶ç”¨å…¶ä¼°è®¡å€¼æ ·æœ¬åæ–¹å·®çŸ©é˜µS~pÃ—p~ ä»£æ›¿

$$
S=\frac{AA^T}{n-1}
$$

-   $A_{ pÃ—n}$ æ˜¾ç¤ºæ¥è‡ªæ¯ä¸ªå˜é‡å€¼ä¸å…¶å‡å€¼çš„åå·® $X_i-\bar X$ï¼›
-   $(AA^T)_{ii}$ æ˜¾ç¤ºåå·®å¹³æ–¹å’Œ ï¼ˆæ ·æœ¬æ–¹å·® $s_i^2$ ï¼‰ï¼›
-   $(AA^T)_{ij}ï¼Œi\ne j$ æ˜¾ç¤ºæ ·æœ¬åæ–¹å·® $s_{ij} = (A çš„è¡Œ i) Â· (A çš„è¡Œ j)$ã€‚

```{r}
# æ‰‹åŠ¨è®¡ç®—åæ–¹å·®çŸ©é˜µ
A <- as.matrix(t((df_center)))
AA_T <- A %*% t(A)
S <- AA_T / (nrow(df_center) - 1)
S
# å†…ç½®åæ–¹å·®çŸ©é˜µå‡½æ•°
cov(df_center)
```

### è®¡ç®—ç›¸å…³ç³»æ•°çŸ©é˜µ

ç›¸å…³ç³»æ•°çŸ©é˜µ $R=(r_{ij})$ çš„å…¬å¼ä¸ºï¼š

$$
r_{ij}=\frac {S_{ij}}{\sqrt{S_{ii}Ã—S_{jj}}}
$$

```{r}
# å®šä¹‰è‡ªå®šä¹‰å‡½æ•°è®¡ç®—ç›¸å…³ç³»æ•°çŸ©é˜µ
r <- function(df){
    df <- as.data.frame(df)
    n=length(df)
    names <- colnames(df)
    df <- scale(df)
    S <- cov(df)
    r <- matrix(data = NA,n,n,dimnames = list(names,names))
    for(i in 1:n){
        for(j in 1:n){
            r[i,j]=S[i,j]/sqrt(S[i,i]*S[j,j])
        }
    }
    return(r)
}
r(df)

# ä½¿ç”¨å†…ç½®çš„ç›¸å…³ç³»æ•°çŸ©é˜µå‡½æ•°
cor(df_center)
```

### æ€»æ–¹å·®

æ€»æ–¹å·®T=æ‰€æœ‰ç‰¹å¾å€¼çš„æ€»å’Œ=æ ·æœ¬æ–¹å·®çš„æ€»å’Œ=åæ–¹å·®çŸ©é˜µçš„è¿¹(å¯¹è§’çº¿çš„æ€»å’Œ)

`sum(eigen(AA_T)$values)`=`sum(diag(AA_T))`= `sum(svd$d^2)`

```{r}
# AA^Tçš„ç‰¹å¾å€¼
y <- eigen(AA_T)
y$values
y$vectors

# ç‰¹å¾å€¼çš„å’Œ
sum(y$values)

# è¿¹
sum(diag(AA_T))
```

### å¥‡å¼‚å€¼åˆ†è§£ä¸ä¸»æˆåˆ†æ¨å¯¼

SVDå…¬å¼ï¼š

$$
A_{pÃ—n}=U\Sigma V^T 
$$

A æ˜¯ä¸­å¿ƒåŒ–åçš„æ•°æ®çŸ©é˜µï¼Œ U æ˜¯å·¦å¥‡å¼‚çŸ©é˜µï¼Œ $\Sigma$ æ˜¯å¥‡å¼‚å€¼å¯¹è§’çŸ©é˜µï¼Œ V æ˜¯å³å¥‡å¼‚çŸ©é˜µï¼ˆï¼ˆä¹Ÿæ˜¯ä¸»æˆåˆ†æ–¹å‘ï¼‰ï¼‰

ä¸»æˆåˆ†æ¨å¯¼ï¼š

$$ PC=A\cdot V=U \Sigma  $$

åœ¨è¿™ä¸ªå…¬å¼ä¸­ï¼š

-   $U$ æ˜¯åŒ…å«å·¦å¥‡å¼‚å‘é‡çš„çŸ©é˜µï¼Œè¡¨ç¤ºæ ·æœ¬åœ¨æ–°åæ ‡ç³»ä¸­çš„åæ ‡ã€‚

-   $\Sigma$ æ˜¯åŒ…å«å¥‡å¼‚å€¼çš„å¯¹è§’çŸ©é˜µï¼Œè¿™äº›å¥‡å¼‚å€¼ä¸ç‰¹å¾å€¼ç›¸å…³ï¼Œè¡¨ç¤ºæ¯ä¸ªä¸»æˆåˆ†çš„æ–¹å·®å¤§å°ã€‚

```{r}

# è¿›è¡Œå¥‡å¼‚å€¼åˆ†è§£

svd <- svd(df_center)
svd$d
svd$u
svd$v
# å¥‡å¼‚å€¼çš„å¹³æ–¹å’Œ
sum(svd$d^2)

# å¥‡å¼‚å€¼çš„å¯¹è§’çŸ©é˜µ
D <- diag(svd$d)

#  df_center  X = U D V'
X <- svd$u %*% D %*% t(svd$v) 

#  D = U' X V
t(svd$u) %*% X %*% svd$v
```

### ç»“æœè§£é‡Š

#### ä¸»æˆåˆ†è·è½½ç³»æ•°

```{r}
# ä¸»æˆåˆ†è·è½½ç³»æ•°
svd$v
```

åœ¨PCAä¸­ï¼Œå³å¥‡å¼‚å‘é‡çŸ©é˜µğ‘‰ çš„åˆ—å‘é‡ä»£è¡¨æ•°æ®åœ¨æ–°çš„æ­£äº¤åŸºä¸Šçš„æ–¹å‘ï¼Œè¿™äº›åŸºæ˜¯æŒ‰æ•°æ®ä¸­æ–¹å·®æœ€å¤§åŒ–çš„æ–¹å‘æ’åˆ—çš„ã€‚æ¯ä¸ªå‘é‡å°±æ˜¯ä¸€ä¸ªä¸»æˆåˆ†æ–¹å‘ã€‚å…·ä½“æ¥è¯´ï¼ŒçŸ©é˜µ `svd$v` ä¸­çš„æ¯ä¸€åˆ—éƒ½æ˜¯ä¸€ä¸ª**ä¸»æˆåˆ†**ï¼Œ ä¸”è¿™äº›åˆ—å‘é‡å¯ä»¥çœ‹ä½œæ˜¯åŸå§‹å˜é‡åœ¨æ–°ä¸»æˆåˆ†ç©ºé—´ä¸­çš„çº¿æ€§ç»„åˆç³»æ•°ã€‚

å› æ­¤ï¼Œ`svd$v` ä¸­çš„å…ƒç´ è¡¨ç¤ºçš„æ˜¯æ¯ä¸ªåŸå§‹å˜é‡åœ¨å¯¹åº”ä¸»æˆåˆ†ä¸Šçš„è´¡çŒ®ï¼Œå³ä¸»æˆåˆ†è·è½½ç³»æ•°ï¼ˆloadingsï¼‰ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœ `V` çš„ç¬¬j ä¸ªåˆ—å‘é‡ä¸º $[v_{1j},v_{2j},...,v_{pj}]$ ï¼Œè¿™æ„å‘³ç€ç¬¬j ä¸ªä¸»æˆåˆ†å¯ä»¥è¡¨ç¤ºä¸ºåŸå§‹å˜é‡çš„çº¿æ€§ç»„åˆï¼š

$$
PC_j=v_{1j}\cdot x_1+v_{2j}\cdot x_2+...+v_{pj}\cdot x_p
$$

å…¶ä¸­ï¼Œ $x_1,x_2,...,x_p$ æ˜¯åŸå§‹å˜é‡ï¼Œ $v_{1j},v_{2j},...,v_{pj}$ æ˜¯å®ƒä»¬åœ¨ç¬¬j ä¸ªä¸»æˆåˆ†ä¸Šçš„è·è½½ç³»æ•°ã€‚

#### ä¸»æˆåˆ†å¾—åˆ†

ä¸»æˆåˆ†å¾—åˆ† (principal component scores) ä»£è¡¨äº†åŸå§‹æ•°æ®åœ¨æ–°ä¸»æˆåˆ†è½´ä¸Šçš„åæ ‡ã€‚

å…·ä½“æ¥è¯´ï¼Œä¸»æˆåˆ†å¾—åˆ†å¯ä»¥è¡¨ç¤ºä¸ºï¼š

$$
Scores = U\Sigma
$$

```{r}
# å¾—åˆ†
svd$u %*% D
```

#### ä¸»æˆåˆ†æ ‡å‡†å·®

![](images/clipboard-305502058.png)

$$
Standard \ Deviation \ of \ PC_i =\frac{\sigma_i}{\sqrt{n-1}}
$$

å…¶ä¸­ï¼Œn æ˜¯æ ·æœ¬é‡ï¼ŒÏƒ æ˜¯å¥‡å¼‚å€¼ã€‚

```{r}
svd$d /sqrt(nrow(df_center)-1)
```

#### æ–¹å·®è´¡çŒ®ç™¾åˆ†æ¯”

åœ¨ä¸»æˆåˆ†åˆ†æ (PCA) ä¸­ï¼Œæ–¹å·®è´¡çŒ®ç™¾åˆ†æ¯”ï¼ˆvariance explained ratioï¼‰æ˜¯ç”¨æ¥è¡¡é‡æ¯ä¸ªä¸»æˆåˆ†è§£é‡Šäº†æ•°æ®æ€»æ–¹å·®çš„æ¯”ä¾‹ã€‚è¿™ä¸ªæ¯”ä¾‹å¯ä»¥é€šè¿‡å¥‡å¼‚å€¼åˆ†è§£ (SVD) çš„å¥‡å¼‚å€¼æ¥è®¡ç®—ã€‚

å…·ä½“æ¥è¯´ï¼Œæ–¹å·®è´¡çŒ®ç™¾åˆ†æ¯”çš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š

1.  è®¡ç®—æ¯ä¸ªä¸»æˆåˆ†çš„æ–¹å·®ã€‚å¥‡å¼‚å€¼çš„å¹³æ–¹ $\sigma_i^2$ è¡¨ç¤ºä¸»æˆåˆ† $ğ‘–$çš„æ–¹å·®ã€‚

2.  è®¡ç®—æ€»æ–¹å·®ï¼Œå³æ‰€æœ‰å¥‡å¼‚å€¼çš„å¹³æ–¹å’Œã€‚

3.  æ¯ä¸ªä¸»æˆåˆ†çš„æ–¹å·®è´¡çŒ®ç™¾åˆ†æ¯”å¯ä»¥é€šè¿‡å°†æ¯ä¸ªå¥‡å¼‚å€¼çš„å¹³æ–¹é™¤ä»¥æ€»æ–¹å·®æ¥è®¡ç®—ã€‚

```{r}
# æ–¹å·®è´¡çŒ®ç™¾åˆ†æ¯”
pct <- svd$d^2/sum(svd$d^2)
pct

# ç´¯è®¡æ–¹å·®è´¡çŒ®ç™¾åˆ†æ¯”
cumsum(pct)
```

## å†…ç½®PCA

```{r}
pca <- prcomp(df_center)
pca
summary(pca)
```

## å¯è§†åŒ–åˆ†æ

### åˆ¤æ–­ä¸»æˆåˆ†çš„ä¸ªæ•°

1.  Cattellç¢çŸ³å›¾ å›¾å½¢å˜åŒ–æœ€å¤§å¤„ï¼Œå³æ‹è§’å¤„
2.  Kaiser-Harriså‡†åˆ™ ç‰¹å¾å€¼å¤§äº1ï¼Œç›´çº¿y=1ä»¥ä¸Š
3.  å¹³è¡Œåˆ†æ åŸºäºçœŸå®æ•°æ®çš„ç‰¹å¾å€¼å¤§äºä¸€ç»„éšæœºæ•°æ®çŸ©é˜µç›¸åº”çš„ç‰¹å¾å€¼ï¼ˆè™šçº¿ï¼‰

### ç¢çŸ³å›¾

```{r}
# Create Scree Plot
screeplot(pca, type = "lines", main = "Scree Plot")

library(ggplot2)
explained_variance <- pca$sdev^2 / sum(pca$sdev^2)
explained_variance_df <- data.frame(
  Principal_Component = paste0("PC", 1:length(explained_variance)),
  Explained_Variance = explained_variance
)

ggplot(explained_variance_df, aes(x = Principal_Component, y = Explained_Variance)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_line(aes(group = 1), color = "blue") +
  geom_point(color = "red") +
  labs(title = "Scree Plot", x = "Principal Component", y = "Explained Variance") +
  theme_minimal()
```

#### å¹³è¡Œåˆ†æ

```{r}
fa_parallel <- psych::fa.parallel(df_center, fa = "pc", n.iter = 100)
```

```{r}
svd$v
tibble(x = 1:4, pc1 = svd$v[, 1]) %>%
    ggplot(aes(x, pc1)) +
    geom_point() +
    theme_classic() +
    theme(panel.border = element_rect(
        color = "black",
        fill = NA,
    ), # æ·»åŠ å››å‘¨æ¡†çº¿
    )

plot(svd$v[,1],ylab = "1st PC")
plot(svd$v[,1],svd$v[,2],xlab="lst PC",ylab="2nd PC")

```

## tidy ä¸»æˆåˆ†åˆ†æ

```{r}
library(tidymodels)
```

```{r}
df <- as_tibble(USArrests, rownames = "state")
df

df |>
  select(-state) |>
  map_dfr(mean)  #apply(.,2,mean)
```

```{r}
df_pca <- df |>
  select(-state) |>
  stats::prcomp(scale = TRUE)
```

ä¸»æˆåˆ†å¾—åˆ†ï¼Œè¡¨ç¤ºä¸»æˆåˆ†ä¸åŸæœ‰è§‚æµ‹çš„ç›¸å…³ç³»æ•°

```{r}
df_pca$x

# by default    df_pca$x
broom::tidy(df_pca, matrix = "scores") |> 
    pivot_wider(id_cols = everything(),
                names_from = PC,
                names_prefix = "PC",
               values_from = value)
```

ä¸»æˆåˆ†è·è½½ï¼ˆloadingï¼‰ï¼šè¡¨ç¤ºä¸»æˆåˆ†ä¸åŸæœ‰å˜é‡çš„ç›¸å…³ç³»æ•°

```{r}
df_pca$rotation

# df_pca$Rotation
tidy(df_pca, matrix = "loadings") |> 
    pivot_wider(
        names_from = PC,
        names_prefix = "PC",
        values_from = value,
    )
```

ä¾‹å¦‚ï¼š

$$
PC_1=-0.536Murrder-0.583Assault-0.278UrbanPop-0.543Rape
$$

```{r}

tidy(df_pca, matrix = "loadings") |>
  ggplot(aes(value, column)) +
  facet_wrap(~ PC) +
  geom_col() +
  scale_x_continuous(labels = scales::percent)
```

ç‰¹å¾å€¼ eigenvaluesï¼Œé«˜ç»´æ¤­çƒçš„ä¸»è½´é•¿åº¦ï¼Œç›¸å…³çŸ©é˜µçš„ç‰¹å¾å€¼ã€‚

æ–¹å·®ç™¾åˆ†æ¯”è´¡çŒ®ã€‚

```{r}
# screen plot
tidy(df_pca, matrix = "eigenvalues") |>
    ggplot(aes(PC, percent)) +
    geom_point(color = "red") +
    geom_line()+
    scale_y_continuous(labels = scales::percent)
```
